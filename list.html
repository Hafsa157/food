<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search results</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      padding: 0;
      color: #333;
      text-align: center;
    }
    
    h2, hr {
      text-align: middle;
      margin-left: 20px; /* Adjust as needed */
    }
    
    h2 {
      font-size: 2rem;
      margin: 20px 0;
      color: #006d66;
      font-weight: bold;
    }
    
    hr {
      border: none;
      height: 4px;
      background: repeating-linear-gradient(
        to right,
        #666,
        #666 5px,
        transparent 5px,
        transparent 10px
      );
      margin: 20px auto;
      width: 80%;
    }
    
    .search-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center; /* Centers items vertically */
      text-align: center; /* Ensures the text inside is centered */
    }
    
    .search-field {
      display: flex;
      flex-direction: column;
      text-align: left;
    }
    
    .search-field label {
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 5px;
      color: black;
    }
    
    .search-field input {
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 1rem;
      width: 300px;
      background-color: #f7f8f9;
    }
    
    /* Back to Map Button */
    .back-button {
      display: inline-block;
      margin: 20px;
      padding: 12px 24px;
      background-color: #00796b;
      color: white;
      text-decoration: none;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    
    .back-button:hover {
      background-color: #004d40;
      transform: scale(1.05);
    }
    
    .back-button:active {
      background-color: #00332e;
      transform: scale(0.98);
    }
    
    /* Table Styling */
    #food-list {
      width: 89%;
      margin: auto;
      border-collapse: collapse;
    }
    
    #food-list th, #food-list td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    
    /* Increase font size for Business Name */
    .business-name {
      font-size: 1.7rem; /* Bigger for better visibility */
      font-weight: bold;
      color: #00796b;
    }
    
    /* Increase font size for Address */
    .business-address {
      font-size: 1.5rem; /* Slightly smaller than Business Name but still large */
      color: #333;
      line-height: 1.6; /* Improves spacing for readability */
    }
    
    /* Table Cell Styling (Keeps Everything Else the Same) */
    #food-list td {
      font-size: 1.4rem; /* Increase text size while keeping layout unchanged */
      padding: 12px;
    }
    
    .search-btn, #reset-btn {
      padding: 12px 24px; /* Adjust the padding for a better appearance */
      background-color: #00796b; /* Background color */
      color: white; /* Text color */
      border: none; /* No border */
      border-radius: 10px; /* Rounded corners */
      font-size: 1rem; /* Font size */
      font-weight: 600;
      cursor: pointer; /* Pointer cursor on hover */
      margin-top: 20px; /* Margin at the top */
      width: auto; /* Set width to auto for flexible width */
      display: inline-block; /* Allow buttons to sit next to each other */
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    
    .search-btn:hover, #reset-btn:hover {
      background-color: #004d40; /* Darker green */
      transform: scale(1.05); /* Slight hover scaling effect */
    }
    
    /* Active (click) effect */
    .search-btn:active, #reset-btn:active {
      background-color: #00332e;
      transform: scale(0.98); /* Press-in effect */
    }
    
    /* Flexbox to align buttons properly */
    .button-container {
      display: flex;
      justify-content: center;
      gap: 15px; /* Adds spacing between buttons */
      margin-top: 20px;
    }
  
    .pagination-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px; /* Space between buttons and page info */
    margin-top: 20px;
    flex-wrap: wrap; /* Prevents layout breaking on smaller screens */
}

.pagination-button {
    padding: 8px 16px; /* Adjust padding for better fit */
    border: none;
    background-color: #00796b;
    color: white;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    text-decoration: none;
    border-radius: 5px;
    min-width: 80px; /* Ensures buttons are not too wide */
    max-width: 120px; /* Prevents buttons from taking too much space */
    text-align: center;
    white-space: nowrap; /* Prevents text wrapping */
    transition: background-color 0.3s ease, transform 0.1s ease;
}

.pagination-button:hover {
    background-color: #004d40;
    transform: scale(1.05);
}

.pagination-button:active {
    background-color: #00332e;
    transform: scale(0.98);
}

#page-info {
    font-size: 1rem;
    font-weight: bold;
    color: #333;
    text-align: center;
    min-width: 120px; /* Keeps text aligned properly */
}


 .result-count {
  font-size: 1.2rem;
  margin: 0; /* Reset margin */
  margin-left: 60px; /* Move the text to the right */
  color: #333;

 }


    
    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      font-size: 1.2rem;
      font-weight: bold;
      color: #333;
    }
    
    .sort-container {
    display: flex;
    flex-direction: row; /* Keep text and dropdown in one line */
    align-items: center;
    gap: 5px;
    position: relative;
    left: -80px; /* Adjust if needed */
    white-space: nowrap; /* Prevent text from breaking into two lines */
}

.sort-text {
    display: inline-block; /* Ensure text stays on the same line */
}

#sort-select {
    padding: 8px 12px;
    font-size: 1rem;
    font-weight: bold;
    background-color: #f8f9fa;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
}


#sort-select:hover {
    background-color: #eef1f4;
}















body {
    padding-bottom: 50px; /* Adds extra white space at the bottom */
}

.pagination-container {
    margin-bottom: 40px; /* Adds space below pagination */
}





















    
























  </style>
</head>

<body>
  <h2>Search for a food hygiene rating</h2>
  <hr />

  <!-- Search Form -->
  <form id="search-form">
    <div class="search-container">
      <div class="search-field">
        <label for="search-business">Business name</label>
        <input type="text" id="search-business" placeholder="Enter business name..." />
      </div>
  
      <div class="search-field">
        <label for="search-location">Street, town or postcode</label>
        <input type="text" id="search-location" placeholder="Enter location..." />
      </div>
    </div>
  
    <button type="submit" class="search-btn">Search</button>
    <a href="index.html" class="back-button">Back to Map</a>
    <button type="button" id="reset-btn" class="search-btn">Reset</button>
  </form>
  
  <!-- Results Info and Sorting -->
  <div class="results-header">
    <div class="result-count">
      <span>Showing</span>
      <span id="results-start">1</span> - <span id="results-end">10</span>
      <span>of</span>
      <span id="total-results">0</span>
      <span>results</span>
    </div>
    <div class="sort-container">
      <label for="sort-select">Sort by</label>
      <select id="sort-select">
        <option value="">All Ratings</option> 
        <option value="5">5 (Very Good)</option> 
        <option value="4">4 (Good)</option> 
        <option value="3">3 (Generally Satisfactory)</option> 
        <option value="2">2 (Improvement Necessary)</option> 
        <option value="1">1 (Major Improvement Necessary)</option> 
        <option value="0">0 (Urgent Improvement Necessary)</option>
        
      </select>
    </div>
  </div>

  <!-- Table -->
  <table id="food-list">
    <thead>
      <tr>
        <th>Business Name</th>
        <th>Address</th>
        <th>Rating</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Pagination -->
  <div class="pagination" id="pagination"></div>

  <script>
   
  
   let itemsPerPage = 10;
let currentPage = 1;
let filteredData = null;
let userLocation = null;
let geojsonData = null; // Store the original GeoJSON data

// ‚úÖ Request geolocation immediately on page load
window.onload = function () {
    console.log("üìç Page loaded, requesting geolocation...");
    requestGeolocation(() => {
        initializePage();
    });
};

function requestGeolocation(callback) {
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lon: position.coords.longitude,
                };
                console.log("‚úÖ User location retrieved:", userLocation);
                if (callback) callback();
            },
            (error) => {
                console.warn("‚ö†Ô∏è Geolocation denied or unavailable:", error.message);
                alert("Please enable location access for sorting by distance.");
                if (callback) callback();
            }
        );
    } else {
        alert("‚ö†Ô∏è Geolocation is not supported in this browser.");
        if (callback) callback();
    }
}

function initializePage() {
    const storedData = localStorage.getItem("geojsonData");

    if (!storedData) {
        console.error("‚ùå No GeoJSON data found in localStorage.");
        return;
    }

    geojsonData = JSON.parse(storedData);
    filteredData = JSON.parse(JSON.stringify(geojsonData)); // Deep copy to prevent corruption
    console.log("‚úÖ Data loaded:", filteredData);

    populateList(filteredData);

    // ‚úÖ Fixed sorting dropdown listener
    document.getElementById("sort-select").addEventListener("change", function () {
        console.log("üîÑ Sorting changed to:", this.value);
        sortResults(this.value);
    });

    document.querySelector(".search-btn").addEventListener("click", function () {
        console.log("üîç Searching...");
        filterResults();
    });

    document.getElementById("reset-btn").addEventListener("click", function () {
    console.log("üîÑ Reset clicked, restoring original data...");

    // Clear search inputs
    document.getElementById("search-business").value = "";
    document.getElementById("search-location").value = "";

    // Reset dropdown selection to "All Ratings"
    document.getElementById("sort-select").value = "";

    // Restore original data
    filteredData = JSON.parse(JSON.stringify(geojsonData));

    // Reset pagination to the first page
    currentPage = 1;

    // Populate the list again with the full dataset
    populateList(filteredData);

    // Scroll back to the top
    window.scrollTo({ top: 0, behavior: "smooth" });
});

  
}






// ‚úÖ Fully working function to calculate distance
function calculateDistance(user, business) {
    const R = 3958.8; // Radius of Earth in miles
    const dLat = (business.LATITUDE - user.lat) * (Math.PI / 180);
    const dLon = (business.LONGITUDE - user.lon) * (Math.PI / 180);
    const lat1 = user.lat * (Math.PI / 180);
    const lat2 = business.LATITUDE * (Math.PI / 180);

    const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return (R * c).toFixed(1); // Returns distance in miles
}

function populateList(data) {
    const listTableBody = document.getElementById("food-list").querySelector("tbody");
    listTableBody.innerHTML = "";

    if (!data || !data.features || data.features.length === 0) {
        console.error("‚ùå No data to display.");
        listTableBody.innerHTML = `<tr><td colspan="3" style="text-align: center; font-size: 1.5rem; color: red;">No results found.</td></tr>`;
        document.getElementById("total-results").textContent = "0";
        document.getElementById("results-start").textContent = "0";
        document.getElementById("results-end").textContent = "0";
        updatePagination();
        return;
    }

    console.log("üìã Displaying", data.features.length, "items...");

    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, data.features.length);
    const paginatedData = data.features.slice(startIndex, endIndex);

    paginatedData.forEach(feature => {
        const ratingImage = feature.properties.RATING_GRAPHIC_URL
            ? `<img src="${feature.properties.RATING_GRAPHIC_URL}" alt="Rating ${feature.properties.RATING}" style="width: 300px; height: auto;">`
            : '<span style="color: red;">No Rating</span>';

        const row = document.createElement("tr");
        row.innerHTML = `
            <td class="business-name">${feature.properties.BUSINESS_NAME || 'N/A'}</td>
            <td class="business-address">${feature.properties.ADDRESS || 'N/A'}</td>
            <td>${ratingImage}</td>
        `;
        listTableBody.appendChild(row);
    });

    document.getElementById("total-results").textContent = data.features.length;
    document.getElementById("results-start").textContent = startIndex + 1;
    document.getElementById("results-end").textContent = endIndex;

    updatePagination();
}































function updatePagination() {
    const totalResults = filteredData.features.length;
    const totalPages = Math.ceil(totalResults / itemsPerPage);

    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const pageInfo = document.getElementById("page-info");

    // Update page info text
    pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

    // Disable "Previous" button on the first page
    prevBtn.disabled = currentPage === 1;

    // Disable "Next" button on the last page
    nextBtn.disabled = currentPage === totalPages || totalResults === 0;
}

// Ensure event listeners are attached correctly
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("prev-btn").addEventListener("click", function () {
        if (currentPage > 1) {
            currentPage--;
            populateList(filteredData);
            window.scrollTo({ top: 0, behavior: "smooth" }); // Scrolls to top smoothly
        }
    });

    document.getElementById("next-btn").addEventListener("click", function () {
        const totalPages = Math.ceil(filteredData.features.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            populateList(filteredData);
            window.scrollTo({ top: 0, behavior: "smooth" }); // Scrolls to top smoothly
        }
    });

    // Update pagination when page loads
    updatePagination();
});

























function sortResults(sortValue) {
    console.log("üîÑ Filtering results for rating:", sortValue);

    if (!geojsonData || !geojsonData.features) {
        console.error("‚ùå No data available.");
        return;
    }

    let filteredFeatures;

    if (sortValue === "") {
        // Show all businesses when "All Ratings" is selected
        filteredFeatures = [...geojsonData.features];
    } else {
        // Convert sortValue to an integer and filter businesses
        const selectedRating = parseInt(sortValue);
        filteredFeatures = geojsonData.features.filter(feature => {
            const businessRating = parseInt(feature.properties.RATING);
            return businessRating === selectedRating;
        });
    }

    // Update filtered data and refresh table
    filteredData.features = filteredFeatures;
    currentPage = 1; // Reset pagination
    populateList(filteredData);
}




































function filterResults() {
    let searchBusiness = document.getElementById("search-business").value.toLowerCase().trim();
    let searchLocation = document.getElementById("search-location").value.toLowerCase().trim();

    if (!geojsonData || !geojsonData.features) {
        console.error("‚ùå No data available for filtering.");
        return;
    }

    // Filtering businesses based on name and location
    let filteredFeatures = geojsonData.features.filter(feature => {
        let businessName = feature.properties.BUSINESS_NAME?.toLowerCase() || "";
        let address = feature.properties.ADDRESS?.toLowerCase() || "";

        let matchesBusiness = searchBusiness ? businessName.includes(searchBusiness) : true;
        let matchesLocation = searchLocation ? address.includes(searchLocation) : true;

        return matchesBusiness && matchesLocation;
    });

    // Update filteredData and refresh the displayed list
    filteredData.features = filteredFeatures;
    currentPage = 1; // Reset pagination
    populateList(filteredData);
}


document.getElementById("search-form").addEventListener("submit", function(event) {
    event.preventDefault(); // Prevents page reload
    console.log("Search triggered!");
    // Your search function here
});


  
</script>



<!-- Pagination Controls -->
  <div class="pagination-container">
    <button id="prev-btn" class="pagination-button" disabled>Previous</button>
    <span id="page-info"></span>
    <button id="next-btn" class="pagination-button">Next</button>
  </div>
